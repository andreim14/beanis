<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Geo-spatial indexing - My Project</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Project</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Overview</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../getting-started/" class="nav-link">Getting started</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Tutorial</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../tutorial-overview/" class="dropdown-item">Tutorial Overview</a>
</li>
                                    
<li>
    <a href="../defining-a-document/" class="dropdown-item">Defining a document</a>
</li>
                                    
<li>
    <a href="../initialization/" class="dropdown-item">Initialization</a>
</li>
                                    
<li>
    <a href="../inserting-into-the-database/" class="dropdown-item">Inserting into the database</a>
</li>
                                    
<li>
    <a href="../finding-documents/" class="dropdown-item">Finding documents</a>
</li>
                                    
<li>
    <a href="../updating-documents/" class="dropdown-item">Updating documents</a>
</li>
                                    
<li>
    <a href="../deleting-documents/" class="dropdown-item">Deleting documents</a>
</li>
                                    
<li>
    <a href="../indexes/" class="dropdown-item">Indexes</a>
</li>
                                    
<li>
    <a href="../event-based-actions/" class="dropdown-item">Event-based actions</a>
</li>
                                    
<li>
    <a href="../custom-encoders/" class="dropdown-item">Custom encoders</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Geo-spatial indexing</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">API Documentation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../api-documentation/document/" class="dropdown-item">Document</a>
</li>
                                    
<li>
    <a href="../../api-documentation/interfaces/" class="dropdown-item">Interfaces</a>
</li>
                                    
<li>
    <a href="../../api-documentation/indexes/" class="dropdown-item">Indexes</a>
</li>
                                    
<li>
    <a href="../../api-documentation/actions/" class="dropdown-item">Actions</a>
</li>
                                    
<li>
    <a href="../../api-documentation/fields/" class="dropdown-item">Fields</a>
</li>
                                    
<li>
    <a href="../../api-documentation/custom-encoders/" class="dropdown-item">Custom Encoders</a>
</li>
                                    
<li>
    <a href="../../api-documentation/custom-types/" class="dropdown-item">Custom Types</a>
</li>
                                    
<li>
    <a href="../../api-documentation/utils/" class="dropdown-item">Utils</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../development/" class="nav-link">Development</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../code-of-conduct/" class="nav-link">Code of conduct</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../changelog/" class="nav-link">Changelog</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../custom-encoders/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../api-documentation/document/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#geo-spatial-indexing" class="nav-link">Geo-Spatial Indexing</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#quick-start" class="nav-link">Quick Start</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#geopoint-type" class="nav-link">GeoPoint Type</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#radius-queries" class="nav-link">Radius Queries</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#real-world-example-food-delivery-service" class="nav-link">Real-World Example: Food Delivery Service</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#more-use-cases" class="nav-link">More Use Cases</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#performance-tips" class="nav-link">Performance Tips</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#limitations" class="nav-link">Limitations</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#benchmark-results" class="nav-link">Benchmark Results</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#comparison-with-mongodb" class="nav-link">Comparison with MongoDB</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#best-practices" class="nav-link">Best Practices</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#troubleshooting" class="nav-link">Troubleshooting</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#next-steps" class="nav-link">Next Steps</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#further-reading" class="nav-link">Further Reading</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="geo-spatial-indexing">Geo-Spatial Indexing</h1>
<p>Build location-based features like store locators, delivery radius checks, and real-time tracking with Redis geo-spatial indexes.</p>
<h2 id="overview">Overview</h2>
<p>Beanis provides built-in support for geo-spatial data through the <code>GeoPoint</code> type and Redis's GEOADD/GEORADIUS commands. This enables fast proximity searches with sub-millisecond query times.</p>
<h3 id="when-to-use-geo-spatial-indexes">When to Use Geo-Spatial Indexes</h3>
<p><strong>Perfect for:</strong>
- Store/restaurant locators ("find stores near me")
- Delivery radius validation
- Real-time vehicle/device tracking
- Geo-fencing applications
- Nearby user discovery</p>
<p><strong>Performance:</strong>
- <strong>Query time:</strong> ~0.2ms average (sub-millisecond)
- <strong>Scalability:</strong> O(log N) - barely increases with dataset size
- <strong>Insert overhead:</strong> ~90-120% slower than non-indexed inserts
- <strong>Distance calc overhead:</strong> ~7% additional time</p>
<h2 id="quick-start">Quick Start</h2>
<pre><code class="language-python">from beanis import Document, GeoPoint, init_beanis
from beanis.odm.indexes import IndexedField, IndexManager
from typing_extensions import Annotated
from redis.asyncio import Redis

# Define document with geo-indexed location
class Store(Document):
    name: str
    address: str
    location: Annotated[GeoPoint, IndexedField()]

    class Settings:
        name = &quot;stores&quot;

# Initialize
redis = Redis(decode_responses=True)
await init_beanis(database=redis, document_models=[Store])

# Create store with location
store = Store(
    name=&quot;Downtown Coffee&quot;,
    address=&quot;123 Main St, San Francisco, CA&quot;,
    location=GeoPoint(longitude=-122.4194, latitude=37.7749)
)
await store.insert()

# Find stores within 5km
nearby_ids = await IndexManager.find_by_geo_radius(
    redis_client=redis,
    document_class=Store,
    field_name=&quot;location&quot;,
    longitude=-122.4200,
    latitude=37.7750,
    radius=5,
    unit=&quot;km&quot;
)

# Get full store documents
nearby_stores = await Store.get_many(nearby_ids)
for store in nearby_stores:
    print(f&quot;{store.name} - {store.address}&quot;)
</code></pre>
<h2 id="geopoint-type">GeoPoint Type</h2>
<h3 id="creating-geopoint">Creating GeoPoint</h3>
<pre><code class="language-python">from beanis import GeoPoint

# Standard format
location = GeoPoint(longitude=-122.4194, latitude=37.7749)

# From dict
location = GeoPoint(**{&quot;longitude&quot;: -122.4194, &quot;latitude&quot;: 37.7749})

# Access values
print(f&quot;Lat: {location.latitude}, Lon: {location.longitude}&quot;)
</code></pre>
<h3 id="validation">Validation</h3>
<p>GeoPoint automatically validates coordinates:</p>
<pre><code class="language-python"># Valid ranges
# Longitude: -180 to 180
# Latitude: -90 to 90

# This raises ValidationError
try:
    invalid = GeoPoint(longitude=200, latitude=37.7)
except ValueError as e:
    print(e)  # &quot;Longitude must be between -180 and 180&quot;
</code></pre>
<h2 id="radius-queries">Radius Queries</h2>
<h3 id="basic-proximity-search">Basic Proximity Search</h3>
<pre><code class="language-python"># Find all stores within 10km
nearby = await IndexManager.find_by_geo_radius(
    redis_client=redis,
    document_class=Store,
    field_name=&quot;location&quot;,
    longitude=-122.4194,
    latitude=37.7749,
    radius=10,
    unit=&quot;km&quot;  # Options: 'm', 'km', 'mi', 'ft'
)

# Returns list of document IDs
print(f&quot;Found {len(nearby)} stores&quot;)
</code></pre>
<h3 id="query-with-distances">Query with Distances</h3>
<p>Get results sorted by distance with actual distance values:</p>
<pre><code class="language-python"># Find stores with distances
results = await IndexManager.find_by_geo_radius_with_distance(
    redis_client=redis,
    document_class=Store,
    field_name=&quot;location&quot;,
    longitude=-122.4194,
    latitude=37.7749,
    radius=10,
    unit=&quot;km&quot;
)

# Returns list of (doc_id, distance) tuples
for store_id, distance in results:
    store = await Store.get(store_id)
    print(f&quot;{store.name}: {distance:.2f} km away&quot;)
</code></pre>
<h3 id="supported-distance-units">Supported Distance Units</h3>
<pre><code class="language-python"># Meters
await IndexManager.find_by_geo_radius(..., radius=1000, unit=&quot;m&quot;)

# Kilometers (default)
await IndexManager.find_by_geo_radius(..., radius=10, unit=&quot;km&quot;)

# Miles
await IndexManager.find_by_geo_radius(..., radius=5, unit=&quot;mi&quot;)

# Feet
await IndexManager.find_by_geo_radius(..., radius=5000, unit=&quot;ft&quot;)
</code></pre>
<h2 id="real-world-example-food-delivery-service">Real-World Example: Food Delivery Service</h2>
<p>Let's build a complete food delivery radius checker:</p>
<pre><code class="language-python">from beanis import Document, GeoPoint
from beanis.odm.indexes import IndexedField, IndexManager
from typing_extensions import Annotated
from typing import List, Optional
from pydantic import BaseModel

# Models
class DeliveryZone(BaseModel):
    name: str
    max_radius_km: float

class Restaurant(Document):
    name: str
    cuisine: str
    location: Annotated[GeoPoint, IndexedField()]
    delivery_zones: List[DeliveryZone]
    is_open: bool

    class Settings:
        name = &quot;restaurants&quot;

class DeliveryAddress(BaseModel):
    location: GeoPoint
    formatted_address: str

# Business logic
class DeliveryService:
    def __init__(self, redis_client):
        self.redis = redis_client

    async def find_available_restaurants(
        self,
        address: DeliveryAddress,
        max_distance_km: float = 10
    ) -&gt; List[tuple[Restaurant, float]]:
        &quot;&quot;&quot;
        Find restaurants that deliver to given address

        Returns list of (restaurant, distance) sorted by distance
        &quot;&quot;&quot;
        # Find all restaurants within max distance
        results = await IndexManager.find_by_geo_radius_with_distance(
            redis_client=self.redis,
            document_class=Restaurant,
            field_name=&quot;location&quot;,
            longitude=address.location.longitude,
            latitude=address.location.latitude,
            radius=max_distance_km,
            unit=&quot;km&quot;
        )

        # Fetch restaurant details and filter by delivery zones
        available = []
        for restaurant_id, distance in results:
            restaurant = await Restaurant.get(restaurant_id)

            # Skip if closed
            if not restaurant.is_open:
                continue

            # Check if address is in any delivery zone
            for zone in restaurant.delivery_zones:
                if distance &lt;= zone.max_radius_km:
                    available.append((restaurant, distance))
                    break

        # Sort by distance
        available.sort(key=lambda x: x[1])
        return available

    async def check_delivery_available(
        self,
        restaurant_id: str,
        address: DeliveryAddress
    ) -&gt; tuple[bool, Optional[float]]:
        &quot;&quot;&quot;
        Check if restaurant delivers to address

        Returns (is_available, distance_km)
        &quot;&quot;&quot;
        restaurant = await Restaurant.get(restaurant_id)
        if not restaurant or not restaurant.is_open:
            return (False, None)

        # Calculate distance
        results = await IndexManager.find_by_geo_radius_with_distance(
            redis_client=self.redis,
            document_class=Restaurant,
            field_name=&quot;location&quot;,
            longitude=address.location.longitude,
            latitude=address.location.latitude,
            radius=max(zone.max_radius_km for zone in restaurant.delivery_zones),
            unit=&quot;km&quot;
        )

        # Find this restaurant in results
        for doc_id, distance in results:
            if doc_id == restaurant_id:
                # Check if in any delivery zone
                for zone in restaurant.delivery_zones:
                    if distance &lt;= zone.max_radius_km:
                        return (True, distance)
                return (False, distance)

        return (False, None)

    async def get_delivery_estimate(
        self,
        restaurant: Restaurant,
        distance_km: float
    ) -&gt; dict:
        &quot;&quot;&quot;
        Calculate delivery time and fee based on distance
        &quot;&quot;&quot;
        # Base delivery time: 20 minutes + 3 min per km
        delivery_time_min = 20 + (distance_km * 3)

        # Delivery fee: $2.99 base + $0.50 per km
        delivery_fee = 2.99 + (distance_km * 0.50)

        return {
            &quot;restaurant_name&quot;: restaurant.name,
            &quot;distance_km&quot;: round(distance_km, 2),
            &quot;estimated_delivery_min&quot;: round(delivery_time_min),
            &quot;delivery_fee&quot;: round(delivery_fee, 2)
        }


# Usage example
async def main():
    from redis.asyncio import Redis
    from beanis import init_beanis

    redis = Redis(decode_responses=True)
    await init_beanis(database=redis, document_models=[Restaurant])

    # Create sample restaurants
    restaurants = [
        Restaurant(
            name=&quot;Pizza Palace&quot;,
            cuisine=&quot;Italian&quot;,
            location=GeoPoint(longitude=-122.4194, latitude=37.7749),
            delivery_zones=[
                DeliveryZone(name=&quot;Downtown&quot;, max_radius_km=5),
                DeliveryZone(name=&quot;Extended&quot;, max_radius_km=10)
            ],
            is_open=True
        ),
        Restaurant(
            name=&quot;Sushi Express&quot;,
            cuisine=&quot;Japanese&quot;,
            location=GeoPoint(longitude=-122.4100, latitude=37.7850),
            delivery_zones=[
                DeliveryZone(name=&quot;Local&quot;, max_radius_km=3)
            ],
            is_open=True
        ),
        Restaurant(
            name=&quot;Burger Joint&quot;,
            cuisine=&quot;American&quot;,
            location=GeoPoint(longitude=-122.4300, latitude=37.7650),
            delivery_zones=[
                DeliveryZone(name=&quot;Wide&quot;, max_radius_km=15)
            ],
            is_open=True
        )
    ]

    for restaurant in restaurants:
        await restaurant.insert()

    # User's delivery address
    user_address = DeliveryAddress(
        location=GeoPoint(longitude=-122.4150, latitude=37.7800),
        formatted_address=&quot;456 Market St, San Francisco, CA&quot;
    )

    # Find available restaurants
    service = DeliveryService(redis)
    available = await service.find_available_restaurants(user_address)

    print(f&quot;Restaurants delivering to {user_address.formatted_address}:\n&quot;)

    for restaurant, distance in available:
        estimate = await service.get_delivery_estimate(restaurant, distance)
        print(f&quot;{estimate['restaurant_name']} ({restaurant.cuisine})&quot;)
        print(f&quot;  Distance: {estimate['distance_km']} km&quot;)
        print(f&quot;  Delivery time: ~{estimate['estimated_delivery_min']} min&quot;)
        print(f&quot;  Delivery fee: ${estimate['delivery_fee']}&quot;)
        print()

    await redis.aclose()

# Run
import asyncio
asyncio.run(main())
</code></pre>
<p>Output:</p>
<pre><code>Restaurants delivering to 456 Market St, San Francisco, CA:

Pizza Palace (Italian)
  Distance: 0.73 km
  Delivery time: ~22 min
  Delivery fee: $3.36

Sushi Express (Japanese)
  Distance: 1.12 km
  Delivery time: ~23 min
  Delivery fee: $3.55

Burger Joint (American)
  Distance: 2.21 km
  Delivery time: ~27 min
  Delivery fee: $4.10
</code></pre>
<h2 id="more-use-cases">More Use Cases</h2>
<h3 id="store-locator">Store Locator</h3>
<pre><code class="language-python">class Store(Document):
    name: str
    address: str
    phone: str
    location: Annotated[GeoPoint, IndexedField()]
    store_hours: dict

    class Settings:
        name = &quot;stores&quot;

async def find_nearest_store(user_lat: float, user_lon: float, limit: int = 5):
    &quot;&quot;&quot;Find nearest stores to user&quot;&quot;&quot;
    results = await IndexManager.find_by_geo_radius_with_distance(
        redis_client=redis,
        document_class=Store,
        field_name=&quot;location&quot;,
        longitude=user_lon,
        latitude=user_lat,
        radius=50,  # Within 50km
        unit=&quot;km&quot;
    )

    # Get top N nearest
    nearest = results[:limit]

    stores_with_distance = []
    for store_id, distance in nearest:
        store = await Store.get(store_id)
        stores_with_distance.append({
            &quot;store&quot;: store,
            &quot;distance_km&quot;: distance,
            &quot;distance_mi&quot;: distance * 0.621371  # Convert to miles
        })

    return stores_with_distance
</code></pre>
<h3 id="real-time-vehicle-tracking">Real-Time Vehicle Tracking</h3>
<pre><code class="language-python">from datetime import datetime

class Vehicle(Document):
    vehicle_id: str
    driver_name: str
    location: Annotated[GeoPoint, IndexedField()]
    last_updated: datetime
    is_available: bool

    class Settings:
        name = &quot;vehicles&quot;

async def find_nearest_available_driver(
    pickup_location: GeoPoint,
    max_distance_km: float = 5
) -&gt; Optional[tuple[Vehicle, float]]:
    &quot;&quot;&quot;Find nearest available driver for ride-hailing&quot;&quot;&quot;
    results = await IndexManager.find_by_geo_radius_with_distance(
        redis_client=redis,
        document_class=Vehicle,
        field_name=&quot;location&quot;,
        longitude=pickup_location.longitude,
        latitude=pickup_location.latitude,
        radius=max_distance_km,
        unit=&quot;km&quot;
    )

    # Find first available driver
    for vehicle_id, distance in results:
        vehicle = await Vehicle.get(vehicle_id)
        if vehicle.is_available:
            return (vehicle, distance)

    return None

async def update_vehicle_location(vehicle_id: str, new_location: GeoPoint):
    &quot;&quot;&quot;Update driver location in real-time&quot;&quot;&quot;
    vehicle = await Vehicle.get(vehicle_id)
    vehicle.location = new_location
    vehicle.last_updated = datetime.utcnow()
    await vehicle.save()  # Geo index automatically updated
</code></pre>
<h3 id="geo-fencing-zone-detection">Geo-Fencing / Zone Detection</h3>
<pre><code class="language-python">class GeofenceZone(Document):
    name: str
    center: Annotated[GeoPoint, IndexedField()]
    radius_km: float
    zone_type: str  # &quot;delivery&quot;, &quot;restricted&quot;, &quot;premium&quot;

    class Settings:
        name = &quot;geofence_zones&quot;

async def check_if_in_zone(
    location: GeoPoint,
    zone_type: Optional[str] = None
) -&gt; List[GeofenceZone]:
    &quot;&quot;&quot;Check if location is within any geofence zones&quot;&quot;&quot;
    # Query with large radius to get all potential zones
    results = await IndexManager.find_by_geo_radius_with_distance(
        redis_client=redis,
        document_class=GeofenceZone,
        field_name=&quot;center&quot;,
        longitude=location.longitude,
        latitude=location.latitude,
        radius=100,  # Max zone size
        unit=&quot;km&quot;
    )

    zones_containing_location = []
    for zone_id, distance in results:
        zone = await GeofenceZone.get(zone_id)

        # Check if location is within zone's radius
        if distance &lt;= zone.radius_km:
            if zone_type is None or zone.zone_type == zone_type:
                zones_containing_location.append(zone)

    return zones_containing_location
</code></pre>
<h2 id="performance-tips">Performance Tips</h2>
<h3 id="1-choose-appropriate-radius">1. Choose Appropriate Radius</h3>
<p>Smaller radius = faster queries:</p>
<pre><code class="language-python"># Fast: ~0.19ms
nearby = await find_by_geo_radius(..., radius=1, unit=&quot;km&quot;)

# Still fast: ~0.23ms
nearby = await find_by_geo_radius(..., radius=10, unit=&quot;km&quot;)

# Slower: ~0.27ms (more results to process)
nearby = await find_by_geo_radius(..., radius=50, unit=&quot;km&quot;)
</code></pre>
<h3 id="2-batch-queries-when-possible">2. Batch Queries When Possible</h3>
<pre><code class="language-python"># ❌ Slow: Multiple round-trips
for user in users:
    nearby = await find_by_geo_radius(user.location, ...)

# ✅ Better: Batch processing
user_locations = [user.location for user in users]
# Process in batches or use async gather
</code></pre>
<h3 id="3-cache-frequent-queries">3. Cache Frequent Queries</h3>
<pre><code class="language-python">from functools import lru_cache

@lru_cache(maxsize=1000)
def get_cached_nearby_stores(lat: float, lon: float, radius: int):
    # Round coordinates to reduce cache misses
    lat_rounded = round(lat, 3)
    lon_rounded = round(lon, 3)
    # ... query logic
</code></pre>
<h3 id="4-use-distance-only-when-needed">4. Use Distance Only When Needed</h3>
<pre><code class="language-python"># If you only need IDs (7% faster)
ids = await find_by_geo_radius(...)

# If you need distances for sorting/display
results = await find_by_geo_radius_with_distance(...)
</code></pre>
<h2 id="limitations">Limitations</h2>
<h3 id="cannot-combine-with-other-indexes">Cannot Combine with Other Indexes</h3>
<p>Geo queries are separate from other index queries:</p>
<pre><code class="language-python"># ❌ Cannot do this in one query
# &quot;Find Italian restaurants within 5km&quot;

# ✅ Do this instead:
# 1. Find by geo proximity
nearby_ids = await find_by_geo_radius(..., radius=5)

# 2. Filter by other criteria
nearby_restaurants = await Restaurant.get_many(nearby_ids)
italian = [r for r in nearby_restaurants if r.cuisine == &quot;Italian&quot;]
</code></pre>
<h3 id="one-geopoint-per-document">One GeoPoint Per Document</h3>
<p>Each document can only have one geo-indexed location:</p>
<pre><code class="language-python"># ❌ Multiple geo indexes not supported
class Business(Document):
    main_location: Annotated[GeoPoint, IndexedField()]
    warehouse_location: Annotated[GeoPoint, IndexedField()]  # Won't work well

# ✅ Use separate documents
class BusinessLocation(Document):
    business_id: str
    location_type: str  # &quot;main&quot; or &quot;warehouse&quot;
    location: Annotated[GeoPoint, IndexedField()]
</code></pre>
<h2 id="benchmark-results">Benchmark Results</h2>
<p>Based on our comprehensive benchmarks:</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Value</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Query time (avg)</td>
<td>0.2ms</td>
<td>Sub-millisecond</td>
</tr>
<tr>
<td>Query time (P95)</td>
<td>0.21ms</td>
<td>Very consistent</td>
</tr>
<tr>
<td>Insert overhead</td>
<td>90-120%</td>
<td>~2x slower with geo index</td>
</tr>
<tr>
<td>Distance overhead</td>
<td>7%</td>
<td>Minimal cost</td>
</tr>
<tr>
<td>Scalability</td>
<td>O(log N)</td>
<td>Time barely increases</td>
</tr>
</tbody>
</table>
<p><strong>Dataset tested:</strong> 10,000 stores, 25km radius queries</p>
<h2 id="comparison-with-mongodb">Comparison with MongoDB</h2>
<table>
<thead>
<tr>
<th>Feature</th>
<th>MongoDB (2dsphere)</th>
<th>Beanis (Redis GEO)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Query time</td>
<td>5-20ms</td>
<td>0.2ms (10-100x faster)</td>
</tr>
<tr>
<td>Index size</td>
<td>Larger</td>
<td>Smaller (sorted set)</td>
</tr>
<tr>
<td>Complex queries</td>
<td>✅ $near + filters</td>
<td>⚠️ Filter after query</td>
</tr>
<tr>
<td>Distance units</td>
<td>✅ All units</td>
<td>✅ m, km, mi, ft</td>
</tr>
<tr>
<td>Polygon queries</td>
<td>✅ Supported</td>
<td>❌ Radius only</td>
</tr>
<tr>
<td>Max distance</td>
<td>Unlimited</td>
<td>Practical: ~500km</td>
</tr>
</tbody>
</table>
<h2 id="best-practices">Best Practices</h2>
<ol>
<li><strong>Always validate coordinates</strong> - GeoPoint does this automatically</li>
<li><strong>Use appropriate radius</strong> - Start small, increase if needed</li>
<li><strong>Cache frequent locations</strong> - User's home, work addresses</li>
<li><strong>Update locations efficiently</strong> - Geo index updates automatically on save</li>
<li><strong>Consider data distribution</strong> - Works best with evenly distributed points</li>
<li><strong>Monitor query times</strong> - Should stay under 1ms for most use cases</li>
</ol>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="queries-return-no-results">Queries Return No Results</h3>
<pre><code class="language-python"># Check if documents have geo indexes
members = await redis.zrange(&quot;idx:Store:location&quot;, 0, -1)
print(f&quot;Indexed stores: {len(members)}&quot;)

# Verify location is saved correctly
store = await Store.get(store_id)
print(f&quot;Location: {store.location}&quot;)

# Check radius is reasonable
# 1 degree ≈ 111km, so 500km = ~4.5 degrees
</code></pre>
<h3 id="slow-insert-performance">Slow Insert Performance</h3>
<pre><code class="language-python"># If geo indexing is not needed for all documents:
class Store(Document):
    location: GeoPoint  # No index

# Manually index only important stores
await IndexManager.add_to_index(
    redis_client, Store, store.id, &quot;location&quot;, store.location, &quot;geo&quot;
)
</code></pre>
<h2 id="next-steps">Next Steps</h2>
<ul>
<li><a href="../indexes/">Indexes Overview</a> - Learn about other index types</li>
<li><a href="../custom-encoders/">Custom Encoders</a> - Extend GeoPoint with custom fields</li>
<li><a href="../api/indexes.md">API Reference</a> - Full IndexManager documentation</li>
</ul>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://redis.io/commands/geoadd">Redis GEOADD</a></li>
<li><a href="https://redis.io/commands/georadius">Redis GEORADIUS</a></li>
<li><a href="https://en.wikipedia.org/wiki/Haversine_formula">Haversine Formula</a> - Distance calculation method used by Redis</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
